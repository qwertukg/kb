# AGENTS.md — инструкции для код-агентов (Python + PostgreSQL)

Этот файл задаёт общий контекст и правила работы код-агентов в репозитории.
Принцип: **минимальные изменения, воспроизводимость, проверяемость**.

---

## 1) Команды (setup / run / checks)
Сначала проверь в репозитории, что реально используется: `pyproject.toml`, `requirements*.txt`, `Makefile`, `justfile`, `docker-compose.yml`, `.pre-commit-config.yaml`.

### 1.1 Окружение и зависимости (выбери то, что используется в проекте)
**Poetry**
```bash
poetry install
poetry run python -V
```

**uv**
```bash
uv sync
uv run python -V
```

**pip**
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -U pip
pip install -r requirements.txt
```

### 1.2 Запуск приложения
Используй команду проекта (см. README/Makefile). Типовые варианты:
```bash
python -m app
python main.py
uvicorn app.main:app --reload
flask --app app run --debug
```

### 1.3 Линт / формат / типы (если настроено)
```bash
ruff check .
ruff format .
mypy .        # если используется
pyright .     # если используется
```

### 1.4 Тесты
```bash
pytest -q
# один тест:
pytest -q tests/test_file.py::test_name
```

### 1.5 Pre-commit (если включён)
```bash
pre-commit run -a
```

### 1.6 База данных (PostgreSQL)
Если есть Docker Compose — поднимай БД так:
```bash
docker compose up -d db
```

Если БД поднимается иначе — следуй README.

> Важно: не выдумывай команды — используй только то, что реально есть в проекте.

---

## 2) Тестирование (как и когда добавлять тесты)
- Для **багфикса**: тест обязан воспроизвести проблему и падать до фикса.
- Для **новой фичи**: покрывай:
  - happy path,
  - 1–2 негативных сценария,
  - граничные случаи.
- Изоляция тестов:
  - не завязывайся на продовую БД,
  - используй тестовую БД/схему или транзакции и откат,
  - если применяются testcontainers/docker — следуй существующей конфигурации.
- Время/рандом — фиксируй seed или мокай.

---

## 3) Структура проекта (как ориентироваться)
Следуй текущей структуре и не «перекраивай» репозиторий без явной причины. Типичные папки:
- `src/` или пакет приложения (`app/`)
- `tests/`
- `migrations/` (если есть)
- `scripts/`
- `docs/`

Если проект использует `src`-layout — **не ломай импорты** и конфигурацию пакета.

---

## 4) Стиль и качество кода
- Следуй существующему стилю проекта.
- Пиши маленькие функции и делай изменения локальными.
- Ошибки и логи:
  - не глуши исключения без причины,
  - добавляй контекст,
  - **не логируй секреты** (пароли, токены, DSN, PII).
- Типизация:
  - поддерживай типы, если они используются,
  - не добавляй массово аннотации без необходимости.

### Работа с PostgreSQL
- Не собирай SQL строками, если в проекте уже принят ORM/Query Builder (SQLAlchemy, asyncpg, psycopg, etc.).
- Следи за транзакциями и закрытием соединений.
- Избегай N+1 и лишних запросов; выбирай только нужные колонки.
- Все изменения схемы — через миграции (если миграции используются в проекте).

---

## 5) Git-процесс (как оформлять изменения)
- Один PR/коммит — одна задача.
- Минимизируй дифф: не делай «форматирование всего проекта».
- В описании изменений укажи:
  - что было не так / что сделано,
  - как проверить (команды),
  - что затронуто (эндпойнты/SQL/миграции).

---

## 6) Границы (что запрещено и где осторожничать)
### 6.1 Безопасность и секреты
- Никогда не коммить секреты, ключи, токены, пароли, приватные сертификаты.
- Локальные `.env` не коммитятся; если нужно — обновляй только `.env.example`.

### 6.2 Зависимости и конфиги
- Не добавляй зависимости без необходимости.
- Если добавил:
  - обнови `pyproject.toml`/`requirements*.txt`,
  - зафиксируй lock-файл,
  - объясни зачем (кратко в README/docs или в PR).
- Не меняй версию Python/CI/Docker/линтеры, если это не часть задачи.

### 6.3 Внешние эффекты
- Не выполняй разрушительные команды (drop database, delete data) без явного указания.
- Не подключайся к продовой БД из тестов/скриптов.

---

## Definition of Done
Перед завершением задачи убедись:
- изменения минимальны и понятны;
- тесты проходят;
- линтер/формат/типы (если используются) проходят;
- добавлены/обновлены тесты при изменении поведения;
- миграции и документация обновлены, если менялась схема/настройки.

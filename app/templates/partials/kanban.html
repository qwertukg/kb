{% if statuses_by_project %}
  {% for project_id, statuses in statuses_by_project.items() %}
    {% if not current_project_name %}
      {% set project_name = statuses[0].project.name if statuses else "Проект" %}
      <hr class="my-3">
      <h5 class="mb-3">{{ project_name }}</h5>
    {% endif %}
    <div class="mb-4">
      <div class="kanban-scroll" style="overflow-x: auto; overflow-y: hidden; padding-bottom: 1px;">
        <div class="kanban-row" style="display: flex; flex-wrap: nowrap; gap: 1rem;">
          {% for status in statuses %}
            <div class="kanban-column" style="flex: 0 0 320px;">
              <div class="card shadow-sm h-100" style="min-height: calc(100vh - 140px);">
                <div class="card-header">
                  <div class="d-flex align-items-center gap-2">
                    <span class="d-inline-block rounded-circle" style="width: 10px; height: 10px; background: {{ status.color }};"></span>
                    <div class="fw-semibold">{{ status.name }}</div>
                  </div>
                  {% set free_agents = free_agents_by_status.get(status.id, []) %}
                  {% if free_agents %}
                    <div class="d-flex flex-wrap gap-2 mt-2 js-free-agents" data-status-id="{{ status.id }}">
                      {% for agent in free_agents %}
                        <span
                          class="badge js-free-agent"
                          data-agent-name="{{ agent.name }}"
                          style="background-color: {{ status.color }}; font-size: 0.7rem;"
                        >{{ agent.name }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="card-body">
                  {% set assigned_tasks = tasks_by_status.get(status.id, []) %}
                  <div class="d-grid gap-3 js-status-tasks" data-status-id="{{ status.id }}" style="min-height: 220px;">
                    {% if assigned_tasks %}
                      {% for task, agent in assigned_tasks %}
                        <div class="card js-task-card" data-task-id="{{ task.id }}" data-status-id="{{ status.id }}" draggable="true">
                        <div class="card-header py-2 js-task-header">
                          <div>
                            <a class="small" href="{{ url_for('roles.edit_task', task_id=task.id) }}">#{{ task.id }}</a>
                            <span class="fw-semibold small">{{ task.title or "—" }}</span>
                          </div>
                          {% if agent %}
                            <div>
                              <span class="badge" style="background-color: {{ status.color }}; font-size: 0.7rem;">{{ agent.name }}</span>
                            </div>
                          {% endif %}
                        </div>
                          <div
                            class="card-body p-2 js-messages-scroll"
                            data-task-id="{{ task.id }}"
                            data-base-height="140"
                            style="height: 140px; overflow-y: auto;"
                          >
                            {% set ordered_messages = task.messages | sort(attribute='id') %}
                            {% set messages = ordered_messages %}
                            {% include "tasks/messages.html" %}
                          </div>
                          {% set message_count = ordered_messages | length %}
                          {% set author_ids = ordered_messages | map(attribute='author_id') | unique | list %}
                          {% set is_running = running_task_ids is defined and task.id in running_task_ids %}
                          <div class="card-footer d-flex justify-content-between align-items-center gap-3 py-2">
                            <span class="js-llm-spinner{% if not is_running %} d-none{% endif %}">
                              <span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span>
                            </span>
                            <span class="ms-auto d-inline-flex align-items-center gap-3">
                              <span class="d-inline-flex align-items-center gap-1">
                                <i class="bi bi-chat-left-text"></i>
                                <span class="small text-muted js-message-count">{{ message_count }}</span>
                              </span>
                              <span class="d-inline-flex align-items-center gap-1">
                                <i class="bi bi-people"></i>
                                <span class="small text-muted js-author-count">{{ author_ids | length }}</span>
                              </span>
                            </span>
                          </div>
                        </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="text-muted">Статусов пока нет.</div>
{% endif %}

{% extends "base.html" %}

{% set is_edit = project is not none %}

{% block title %}AutoKanban — Проекты{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">{{ "Редактировать" if is_edit else "Новый проект" }}</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('roles.list_projects') }}">Назад</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" action="{{ url_for('roles.update_project', project_id=project.id) if is_edit else url_for('roles.create_project') }}">
        <div class="mb-3">
          <label class="form-label" for="name">Имя</label>
          <input
            class="form-control"
            id="name"
            name="name"
            type="text"
            value="{% if name is defined %}{{ name }}{% elif project %}{{ project.name }}{% else %}{{ "" }}{% endif %}"
            required
          >
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Колонки</label>
            <button class="btn btn-outline-secondary btn-square" type="button" id="add-column-row" aria-label="Добавить статус" title="Добавить статус">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
          {% if not statuses and not project %}
            <div class="text-muted small">Сначала создайте статусы проекта.</div>
          {% endif %}
          <div id="columns-body">
            {% if board_rows is defined and board_rows %}
              {% for row in board_rows %}
                {% if row.is_deleted != "1" %}
                  <div class="d-flex align-items-stretch gap-2 mb-2 js-column-row">
                    <input type="hidden" name="column_id" value="{{ row.column_id }}">
                    <input type="hidden" name="is_deleted" value="{{ row.is_deleted or "0" }}">
                    <select class="form-select js-status-select flex-grow-1" name="status_id">
                      <option value="">Выберите статус</option>
                      {% for status in statuses %}
                        <option value="{{ status.id }}" data-color="{{ status.color }}" {% if row.status_id and row.status_id|int == status.id %}selected{% endif %}>
                          {{ status.name }}
                        </option>
                      {% endfor %}
                    </select>
                    <input class="form-control position-input" name="position" type="number" value="{{ row.position }}">
                    <button class="btn btn-outline-danger js-remove-row btn-square" type="button" aria-label="Убрать" title="Убрать">
                      <i class="bi bi-dash-lg"></i>
                    </button>
                  </div>
                {% endif %}
              {% endfor %}
            {% elif project and project.board %}
              {% for column in project.board %}
                <div class="d-flex align-items-stretch gap-2 mb-2 js-column-row">
                  <input type="hidden" name="column_id" value="{{ column.id }}">
                  <input type="hidden" name="is_deleted" value="0">
                  <select class="form-select js-status-select flex-grow-1" name="status_id">
                    <option value="">Выберите статус</option>
                    {% for status in statuses %}
                      <option value="{{ status.id }}" data-color="{{ status.color }}" {% if status.id == column.status_id %}selected{% endif %}>
                        {{ status.name }}
                      </option>
                    {% endfor %}
                  </select>
                  <input class="form-control position-input" name="position" type="number" value="{{ column.position }}">
                  <button class="btn btn-outline-danger js-remove-row btn-square" type="button" aria-label="Убрать" title="Убрать">
                    <i class="bi bi-dash-lg"></i>
                  </button>
                </div>
              {% endfor %}
            {% else %}
              <div class="d-flex align-items-stretch gap-2 mb-2 js-column-row">
                <input type="hidden" name="column_id" value="">
                <input type="hidden" name="is_deleted" value="0">
                <select class="form-select js-status-select flex-grow-1" name="status_id">
                  <option value="">Выберите статус</option>
                  {% for status in statuses %}
                    <option value="{{ status.id }}" data-color="{{ status.color }}">{{ status.name }}</option>
                  {% endfor %}
                </select>
                <input class="form-control position-input" name="position" type="number" value="">
                <button class="btn btn-outline-danger js-remove-row btn-square" type="button" aria-label="Убрать" title="Убрать">
                  <i class="bi bi-dash-lg"></i>
                </button>
              </div>
            {% endif %}
          </div>
        </div>
        <button class="btn btn-primary" type="submit">Сохранить</button>
      </form>
    </div>
  </div>
  <template id="column-row-template">
    <div class="d-flex align-items-stretch gap-2 mb-2 js-column-row">
      <input type="hidden" name="column_id" value="">
      <input type="hidden" name="is_deleted" value="0">
      <select class="form-select js-status-select flex-grow-1" name="status_id">
        <option value="">Выберите статус</option>
        {% for status in statuses %}
          <option value="{{ status.id }}" data-color="{{ status.color }}">{{ status.name }}</option>
        {% endfor %}
      </select>
      <input class="form-control position-input" name="position" type="number" value="">
      <button class="btn btn-outline-danger js-remove-row btn-square" type="button" aria-label="Убрать" title="Убрать">
        <i class="bi bi-dash-lg"></i>
      </button>
    </div>
  </template>
  <style>
    .btn-square {
      width: calc(1.5em + 0.75rem + 2px);
      height: calc(1.5em + 0.75rem + 2px);
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .position-input {
      width: 80px;
    }
  </style>
  <script>
    const addColumnButton = document.getElementById("add-column-row");
    const columnsBody = document.getElementById("columns-body");
    const columnRowTemplate = document.getElementById("column-row-template");

    const handleRemove = (button) => {
      const row = button.closest(".js-column-row");
      if (!row) {
        return;
      }
      const columnIdInput = row.querySelector('input[name="column_id"]');
      const deleteInput = row.querySelector('input[name="is_deleted"]');
      if (columnIdInput && columnIdInput.value) {
        if (deleteInput) {
          deleteInput.value = "1";
        }
        row.classList.add("d-none");
      } else {
        row.remove();
      }
    };

    const applyStatusColor = (select) => {
      if (!select) {
        return;
      }
      const option = select.options[select.selectedIndex];
      const color = option?.dataset?.color;
      if (color) {
        select.style.borderColor = color;
        select.style.color = color;
      } else {
        select.style.borderColor = "";
        select.style.color = "";
      }
    };

    const applyAllStatusColors = () => {
      columnsBody.querySelectorAll(".js-status-select").forEach((select) => {
        applyStatusColor(select);
      });
    };

    addColumnButton.addEventListener("click", () => {
      const row = columnRowTemplate.content.cloneNode(true);
      columnsBody.appendChild(row);
      applyAllStatusColors();
    });

    columnsBody.addEventListener("click", (event) => {
      const removeButton = event.target.closest(".js-remove-row");
      if (removeButton) {
        handleRemove(removeButton);
      }
    });

    columnsBody.addEventListener("change", (event) => {
      if (event.target.classList.contains("js-status-select")) {
        applyStatusColor(event.target);
      }
    });

    applyAllStatusColors();
  </script>
{% endblock %}
